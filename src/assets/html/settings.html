<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f2f2f7;
            color: #1c1c1e;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .time-input-group input {
            width: 60px;
            padding: 10px;
            border: 1px solid #c7c7cc;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: #007aff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        .status {
            margin-top: 15px;
            color: green;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Настройки</h1>
        <p>Текущее время: <span id="current-time"></span></p>
        <p id="work-status"></p>
        <div class="form-group">
            <label>
                <input type="checkbox" id="auto-start-enabled">
                Автоматическое начало рабочего дня
            </label>
        </div>
        <div class="form-group">
            <label>Время начала (если вкл.)</label>
            <div class="time-input-group">
                <input type="number" id="start-hour" min="0" max="23" placeholder="ЧЧ">
                <span>:</span>
                <input type="number" id="start-minute" min="0" max="59" placeholder="ММ">
            </div>
        </div>
        <div class="form-group">
            <label>Время окончания (если вкл.)</label>
            <div class="time-input-group">
                <input type="number" id="end-hour" min="0" max="23" placeholder="ЧЧ">
                <span>:</span>
                <input type="number" id="end-minute" min="0" max="59" placeholder="ММ">
            </div>
        </div>
        <button id="save-btn">Сохранить</button>
        <p id="status" class="status"></p>
    </div>

    <script>
        const autoStartCheckbox = document.getElementById('auto-start-enabled');
        const startHourInput = document.getElementById('start-hour');
        const startMinuteInput = document.getElementById('start-minute');
        const endHourInput = document.getElementById('end-hour');
        const endMinuteInput = document.getElementById('end-minute');
        const saveBtn = document.getElementById('save-btn');
        const statusEl = document.getElementById('status');

        // Запрашиваем и отображаем текущие настройки при загрузке
        window.electronAPI.getSettings().then(settings => {
            startHourInput.value = settings.startHour ?? 9;
            startMinuteInput.value = (settings.startMinute ?? 0).toString().padStart(2, '0');
            endHourInput.value = settings.endHour ?? 18;
            endMinuteInput.value = (settings.endMinute ?? 0).toString().padStart(2, '0');
            autoStartCheckbox.checked = settings.autoStartEnabled ?? true;
        });

        saveBtn.addEventListener('click', () => {
            const settings = {
                startHour: parseInt(startHourInput.value, 10),
                startMinute: parseInt(startMinuteInput.value, 10),
                endHour: parseInt(endHourInput.value, 10),
                endMinute: parseInt(endMinuteInput.value, 10),
                autoStartEnabled: autoStartCheckbox.checked
            };
            window.electronAPI.saveSettings(settings);
            statusEl.textContent = 'Сохранено!';
            setTimeout(() => statusEl.textContent = '', 2000);
        });

        const timeEl = document.getElementById('current-time');
        const workStatusEl = document.getElementById('work-status');

        async function updateTimers() {
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString();

            try {
                const buttonState = await window.electronAPI.getButtonState();
                const settings = await window.electronAPI.getSettings();
                const endHour = settings.endHour ?? 18;
                const endMinute = settings.endMinute ?? 0;

                if (buttonState && buttonState.includes('Завершить')) {
                    const endTime = new Date();
                    endTime.setHours(endHour, endMinute, 0, 0);

                    if (now < endTime) {
                        const diff = endTime - now;
                        const hours = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0');
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
                        workStatusEl.textContent = `Осталось: ${hours}:${minutes}:${seconds}`;
                    } else {
                        workStatusEl.textContent = 'Рабочий день завершен.';
                    }
                } else if (buttonState && buttonState.includes('Начать')) {
                    workStatusEl.textContent = 'Рабочий день еще не начат.';
                } else {
                    workStatusEl.textContent = 'Статус рабочего дня неизвестен.';
                }
            } catch (error) {
                console.error('Ошибка при получении статуса:', error);
                workStatusEl.textContent = 'Не удалось загрузить статус.';
            }
        }

        setInterval(updateTimers, 1000);
        updateTimers();
    </script>
</body>
</html>