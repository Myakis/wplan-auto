<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --text-color: #1c1c1e;
            --container-bg-color: #fff;
            --border-color: #c7c7cc;
            --button-bg-color: #007aff;
            --button-hover-bg-color: #005bb5;
            --h1-color: #1c1c1e;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: rgb(33, 44, 66);
                --text-color: #f2f2f7;
                --container-bg-color: rgb(52, 64, 90);
                --border-color: #636366;
                --button-bg-color: rgb(0, 76, 255);
                --button-hover-bg-color: rgb(0, 50, 200);
                --h1-color: #f2f2f7;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: var(--container-bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--h1-color);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .time-input-group input {
            width: 60px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
            background-color: var(--container-bg-color);
            color: var(--text-color);
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: var(--button-hover-bg-color);
        }
        .status {
            margin-top: 15px;
            color: green; /* Consider changing this for dark theme if needed */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Настройки</h1>
        <p>Статус разрешений на уведомления: <span id="notification-permission-status"></span></p>
        <p>Текущее время: <span id="current-time"></span></p>
        <p id="work-status"></p>
        <div class="form-group">
            <label>
                <input type="checkbox" id="auto-start-enabled">
                Автоматическое начало рабочего дня
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="notifications-enabled">
                Уведомления о начале/окончании
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="auto-end-enabled">
                Автоподсчет окончания рабочего дня
            </label>
        </div>
        <div class="form-group">
            <label>Время начала (если вкл.)</label>
            <div class="time-input-group">
                <input type="number" id="start-hour" min="0" max="23" placeholder="ЧЧ">
                <span>:</span>
                <input type="number" id="start-minute" min="0" max="59" placeholder="ММ">
            </div>
        </div>
        <div class="form-group">
            <label>Время окончания (если вкл.)</label>
            <div class="time-input-group">
                <input type="number" id="end-hour" min="0" max="23" placeholder="ЧЧ">
                <span>:</span>
                <input type="number" id="end-minute" min="0" max="59" placeholder="ММ">
            </div>
        </div>
        <button id="save-btn">Сохранить</button>
        <p id="status" class="status"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const autoStartCheckbox = document.getElementById('auto-start-enabled');
            const notificationsCheckbox = document.getElementById('notifications-enabled');
            const autoEndCheckbox = document.getElementById('auto-end-enabled');
            const startHourInput = document.getElementById('start-hour');
            const startMinuteInput = document.getElementById('start-minute');
            const endHourInput = document.getElementById('end-hour');
            const endMinuteInput = document.getElementById('end-minute');
            const saveBtn = document.getElementById('save-btn');
            const statusEl = document.getElementById('status');

            // Запрашиваем и отображаем текущие настройки при загрузке
            window.electronAPI.getNotificationPermissionStatus().then(isSupported => {
                const statusEl = document.getElementById('notification-permission-status');
                if (isSupported) {
                    statusEl.textContent = 'Разрешены';
                    statusEl.style.color = 'green';
                } else {
                    statusEl.textContent = 'Отклонены или не поддерживаются';
                    statusEl.style.color = 'red';
                }
            });

            window.electronAPI.getSettings().then(settings => {
                startHourInput.value = settings.startHour ?? 9;
                startMinuteInput.value = (settings.startMinute ?? 0).toString().padStart(2, '0');
                endHourInput.value = settings.endHour ?? 18;
                endMinuteInput.value = (settings.endMinute ?? 0).toString().padStart(2, '0');
                autoStartCheckbox.checked = settings.autoStartEnabled ?? true;
                notificationsCheckbox.checked = settings.notificationsEnabled ?? true;
                autoEndCheckbox.checked = settings.autoEndEnabled ?? true;
                toggleAutoEnd(autoEndCheckbox.checked);
            });

            function calculateEndTime() {
                if (!autoEndCheckbox.checked) return;

                let startHour = parseInt(startHourInput.value, 10);
                let startMinute = parseInt(startMinuteInput.value, 10);

                if (isNaN(startHour) || isNaN(startMinute)) return;

                let endHour = startHour + 8;
                if (endHour >= 24) {
                    endHour -= 24;
                }

                endHourInput.value = endHour;
                endMinuteInput.value = startMinute.toString().padStart(2, '0');
            }

            function toggleAutoEnd(enabled) {
                endHourInput.disabled = enabled;
                endMinuteInput.disabled = enabled;
                if (enabled) {
                    calculateEndTime();
                }
            }

            autoEndCheckbox.addEventListener('change', () => {
                toggleAutoEnd(autoEndCheckbox.checked);
            });

            startHourInput.addEventListener('input', calculateEndTime);
            startMinuteInput.addEventListener('input', calculateEndTime);

            saveBtn.addEventListener('click', () => {
                const settings = {
                    startHour: parseInt(startHourInput.value, 10),
                    startMinute: parseInt(startMinuteInput.value, 10),
                    endHour: parseInt(endHourInput.value, 10),
                    endMinute: parseInt(endMinuteInput.value, 10),
                    autoStartEnabled: autoStartCheckbox.checked,
                    notificationsEnabled: notificationsCheckbox.checked,
                    autoEndEnabled: autoEndCheckbox.checked
                };
                window.electronAPI.saveSettings(settings);
                statusEl.textContent = 'Сохранено!';
                setTimeout(() => statusEl.textContent = '', 2000);
            });

            const timeEl = document.getElementById('current-time');
            const workStatusEl = document.getElementById('work-status');

            async function updateTimers() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString();

                try {
                    const buttonState = await window.electronAPI.getButtonState();
                    const settings = await window.electronAPI.getSettings();
                    const endHour = settings.endHour ?? 18;
                    const endMinute = settings.endMinute ?? 0;

                    if (buttonState && buttonState.includes('Завершить')) {
                        const endTime = new Date();
                        endTime.setHours(endHour, endMinute, 0, 0);

                        if (now < endTime) {
                            const diff = endTime - now;
                            const hours = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0');
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                            const seconds = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
                            workStatusEl.textContent = `Осталось: ${hours}:${minutes}:${seconds}`;
                        } else {
                            workStatusEl.textContent = 'Рабочий день завершен.';
                        }
                    } else if (buttonState && buttonState.includes('Начать')) {
                        workStatusEl.textContent = 'Рабочий день еще не начат.';
                    } else {
                        workStatusEl.textContent = 'Статус рабочего дня неизвестен.';
                    }
                } catch (error) {
                    console.error('Ошибка при получении статуса:', error);
                    workStatusEl.textContent = 'Не удалось загрузить статус.';
                }
            }

            setInterval(updateTimers, 1000);
            updateTimers();

            // Apply theme based on system preference
            const applySystemTheme = () => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            };

            applySystemTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySystemTheme);
        });
    </script>
</body>
</html>
